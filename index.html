<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Akari's Coffee Resonance Lab</title>
    <style>
        :root {
            --bg-color: #121212;
            --panel-bg: rgba(30, 30, 30, 0.8);
            --accent-color: #00f2ff; /* Cyan Neon */
            --danger-color: #ff0055; /* Warning Red */
            --text-color: #e0e0e0;
            --font-main: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: var(--font-main);
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Header Design */
        header {
            width: 100%;
            padding: 20px 0;
            text-align: center;
            background: linear-gradient(90deg, #000, #1a1a1a);
            border-bottom: 1px solid var(--accent-color);
            box-shadow: 0 0 15px rgba(0, 242, 255, 0.2);
        }

        h1 {
            margin: 0;
            font-weight: 300;
            letter-spacing: 2px;
            font-size: 1.5rem;
        }
        
        .subtitle {
            font-size: 0.8rem;
            color: var(--accent-color);
            opacity: 0.8;
        }

        /* Main Lab Container */
        .lab-container {
            position: relative;
            margin-top: 30px;
            width: 320px;
            height: 400px;
            background: radial-gradient(circle at center, #2a2a2a, #000);
            border-radius: 20px;
            box-shadow: inset 0 0 20px #000, 0 10px 30px rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }

        canvas {
            z-index: 10;
        }

        /* UI Control Panel */
        .controls {
            margin-top: 20px;
            width: 90%;
            max-width: 400px;
            background: var(--panel-bg);
            backdrop-filter: blur(10px);
            padding: 20px;
            border-radius: 15px;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .control-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-size: 0.9rem;
            color: var(--accent-color);
        }

        /* Custom Range Slider */
        input[type=range] {
            width: 100%;
            -webkit-appearance: none;
            background: transparent;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 20px;
            width: 20px;
            border-radius: 50%;
            background: var(--accent-color);
            cursor: pointer;
            margin-top: -8px;
            box-shadow: 0 0 10px var(--accent-color);
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            cursor: pointer;
            background: #444;
            border-radius: 2px;
        }

        /* Status Display */
        .status-display {
            display: flex;
            justify-content: space-between;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            margin-top: 10px;
        }
        .status-value {
            color: #fff;
            font-weight: bold;
        }

        /* Akari Mode Switch */
        .switch-container {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #333;
        }
        .toggle-btn {
            background: transparent;
            border: 1px solid var(--accent-color);
            color: var(--accent-color);
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: var(--font-main);
        }
        .toggle-btn.active {
            background: var(--accent-color);
            color: #000;
            box-shadow: 0 0 15px var(--accent-color);
        }

        /* Warning Overlay */
        .warning {
            position: absolute;
            top: 20px;
            right: 20px;
            color: var(--danger-color);
            font-weight: bold;
            opacity: 0;
            transition: opacity 0.2s;
            text-shadow: 0 0 5px var(--danger-color);
            pointer-events: none;
            z-index: 100;
        }

    </style>
</head>
<body>

<header>
    <h1>PHYSICS LAB</h1>
    <div class="subtitle">Exp.03: Fluid Resonance & Walking Rhythm</div>
</header>

<div class="lab-container">
    <div class="warning" id="warningText">WARNING: SPILL DETECTED</div>
    <canvas id="simCanvas" width="320" height="400"></canvas>
</div>

<div class="controls">
    <div class="control-group">
        <label>Walking Speed (Step Frequency)</label>
        <input type="range" id="speedSlider" min="0" max="3.5" step="0.1" value="0">
        <div class="status-display">
            <span>Stand</span>
            <span id="freqDisplay" class="status-value">0.0 Hz</span>
            <span>Run</span>
        </div>
    </div>

    <div class="switch-container">
        <span style="font-size: 0.9rem;">Cup Shape Model:</span>
        <button class="toggle-btn" id="modeBtn" onclick="toggleMode()">Normal Cup</button>
    </div>
    <p style="font-size: 0.75rem; color: #666; margin-top: 10px;">
        *Akari Mode activates the "Tsubo-gata" (flask-like) geometry with anti-slosh overhangs.
    </p>
</div>

<script>
    // --- Physics Configuration ---
    const canvas = document.getElementById('simCanvas');
    const ctx = canvas.getContext('2d');
    
    // Simulation State
    let time = 0;
    let amplitude = 0; // Current wave height
    let driverFreq = 0; // From slider
    let isAkariMode = false;

    // Cup Parameters
    const cup = {
        x: 160,
        y: 250,
        width: 140,
        height: 180,
        waterLevel: 100,
        eigenFreq: 1.8 // Resonance frequency (approx for this size)
    };

    // Physics Loop
    function updatePhysics() {
        // Damping factor (Liquid viscosity)
        const damping = 0.98;
        
        // Driving Force (Walking)
        // If slider is 0, force is 0. Otherwise, sinusoidal force.
        let force = 0;
        if (driverFreq > 0.1) {
            force = Math.sin(time * driverFreq * 5) * 2; // Arbitrary scaling
        }

        // Resonance Logic (Simplified Driven Harmonic Oscillator)
        // If driverFreq is close to eigenFreq, amplitude grows significantly
        let resonanceFactor = 1 / (Math.abs(cup.eigenFreq - driverFreq) + 0.1);
        
        // Cap resonance factor to avoid explosion, but allow it to be high
        if (resonanceFactor > 6) resonanceFactor = 6;

        // Target Amplitude based on drive
        let targetAmp = force * resonanceFactor * 15;

        // Akari Mode: The "Overhang" reduces effective amplitude at the rim
        if (isAkariMode) {
            targetAmp *= 0.3; // Significantly dampen the splash at the rim
        }

        // Smoothly approach target amplitude (Simulation of inertia)
        amplitude = amplitude * 0.9 + targetAmp * 0.1;

        // Spill Detection
        if (Math.abs(amplitude) > 60) {
            document.getElementById('warningText').style.opacity = 1;
            // Shake the canvas slightly for effect
            canvas.style.transform = `translate(${Math.random()*4-2}px, ${Math.random()*4-2}px)`;
        } else {
            document.getElementById('warningText').style.opacity = 0;
            canvas.style.transform = 'none';
        }

        time += 0.05;
    }

    // --- Rendering ---
    function draw() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        // 1. Draw Cup
        ctx.strokeStyle = isAkariMode ? '#00f2ff' : '#aaa'; // Cyan for Akari Mode
        ctx.lineWidth = 4;
        ctx.lineCap = 'round';
        ctx.beginPath();
        
        if (isAkariMode) {
            // Tsubo (Flask) Shape
            ctx.moveTo(cup.x - cup.width/2, cup.y - cup.height/2); // Top Left
            // Curve inward (Neck)
            ctx.bezierCurveTo(
                cup.x - cup.width/3, cup.y - cup.height/2 + 20, 
                cup.x - cup.width/1.8, cup.y, 
                cup.x - cup.width/2, cup.y + cup.height/2
            );
            ctx.lineTo(cup.x + cup.width/2, cup.y + cup.height/2); // Bottom
            // Right Side Mirror
            ctx.bezierCurveTo(
                cup.x + cup.width/1.8, cup.y, 
                cup.x + cup.width/3, cup.y - cup.height/2 + 20, 
                cup.x + cup.width/2, cup.y - cup.height/2
            );
        } else {
            // Normal Cylinder Cup
            ctx.moveTo(cup.x - cup.width/2, cup.y - cup.height/2);
            ctx.lineTo(cup.x - cup.width/2, cup.y + cup.height/2);
            ctx.lineTo(cup.x + cup.width/2, cup.y + cup.height/2);
            ctx.lineTo(cup.x + cup.width/2, cup.y - cup.height/2);
        }
        ctx.stroke();

        // 2. Draw Liquid
        ctx.fillStyle = isAkariMode ? 'rgba(0, 242, 255, 0.6)' : 'rgba(255, 255, 255, 0.8)'; // Coffee or Cyber Fluid
        if (!isAkariMode) ctx.fillStyle = 'rgba(196, 164, 132, 0.9)'; // Coffee color for normal

        ctx.beginPath();
        // Liquid Surface (Sinusoidal wave)
        const surfaceY = cup.y + cup.height/2 - cup.waterLevel;
        
        let leftX = cup.x - cup.width/2 + 4;
        let rightX = cup.x + cup.width/2 - 4;

        if (isAkariMode) {
             // Adjust widths for Tsubo shape roughly
             leftX += 10; rightX -= 10; 
        }

        ctx.moveTo(leftX, surfaceY + amplitude); // Start at left surface
        
        // Wave drawing
        for (let x = leftX; x <= rightX; x+=5) {
            // Simple tilt effect: linear interpolation of amplitude across width
            let progress = (x - leftX) / (rightX - leftX); // 0 to 1
            let waveHeight = amplitude * (progress - 0.5) * 2; // -Amp to +Amp
            ctx.lineTo(x, surfaceY + waveHeight);
        }

        // Bottom of liquid
        ctx.lineTo(rightX, cup.y + cup.height/2 - 4);
        ctx.lineTo(leftX, cup.y + cup.height/2 - 4);
        ctx.closePath();
        ctx.fill();

        // 3. Draw Resonance "Ghost" (Guide)
        // Show where the "Dangerous Frequency" is
        /*
        ctx.fillStyle = 'rgba(255, 0, 85, 0.1)';
        ctx.fillRect(10, 10, (amplitude/60)*100, 5); 
        */
    }

    // --- Main Loop ---
    function animate() {
        updatePhysics();
        draw();
        requestAnimationFrame(animate);
    }

    // --- Interaction ---
    const slider = document.getElementById('speedSlider');
    const freqDisplay = document.getElementById('freqDisplay');
    const modeBtn = document.getElementById('modeBtn');

    slider.addEventListener('input', (e) => {
        driverFreq = parseFloat(e.target.value);
        freqDisplay.textContent = driverFreq.toFixed(1) + " Hz";
        
        // Visual feedback for resonance zone
        if (Math.abs(driverFreq - cup.eigenFreq) < 0.3) {
            freqDisplay.style.color = 'var(--danger-color)';
            freqDisplay.textContent += " (DANGER!)";
        } else {
            freqDisplay.style.color = '#fff';
        }
    });

    function toggleMode() {
        isAkariMode = !isAkariMode;
        if (isAkariMode) {
            modeBtn.textContent = "Akari's Cup (Tsubo)";
            modeBtn.classList.add('active');
        } else {
            modeBtn.textContent = "Normal Cup";
            modeBtn.classList.remove('active');
        }
    }

    // Start
    animate();

</script>
</body>
</html>